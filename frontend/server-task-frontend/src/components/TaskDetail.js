"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = require("react");
const uploadImage_1 = require("../utils/uploadImage");
const processImage_1 = require("../utils/processImage");
const API_BASE = 'https://u4e7e45gee.execute-api.ca-central-1.amazonaws.com/prod';
const TaskDetail = ({ taskId, userId }) => {
    const [task, setTask] = (0, react_1.useState)(null);
    const [editing, setEditing] = (0, react_1.useState)(false);
    const [saving, setSaving] = (0, react_1.useState)(false);
    const [message, setMessage] = (0, react_1.useState)(null);
    const [selectedFile, setSelectedFile] = (0, react_1.useState)(null);
    const [previewUrl, setPreviewUrl] = (0, react_1.useState)(null);
    const [labels, setLabels] = (0, react_1.useState)([]);
    (0, react_1.useEffect)(() => {
        fetch(`${API_BASE}/tasks`)
            .then(res => res.json())
            .then(data => {
            const found = data.find((t) => t.taskId === taskId && t.userId === userId);
            setTask(found);
        });
    }, [taskId, userId]);
    const handleChange = (e) => {
        setTask({ ...task, [e.target.name]: e.target.value });
    };
    const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (file) {
            setSelectedFile(file);
            setPreviewUrl(URL.createObjectURL(file));
        }
    };
    const handleSave = async () => {
        setSaving(true);
        setMessage(null);
        try {
            const res = await fetch(`${API_BASE}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task),
            });
            if (!res.ok)
                throw new Error('Failed to update task');
            const updatedTask = await res.json();
            if (selectedFile && updatedTask.imageUploadUrl) {
                await (0, uploadImage_1.uploadImage)(updatedTask.imageUploadUrl, selectedFile);
                try {
                    const result = await (0, processImage_1.processImage)(updatedTask.taskId);
                    setLabels(result.labels.map((label) => label.Name));
                }
                catch (err) {
                    console.error('Error processing image:', err);
                }
            }
            setTask(updatedTask);
            setMessage('✅ Task updated successfully!');
            setEditing(false);
        }
        catch (err) {
            setMessage(`❌ ${err.message}`);
        }
        finally {
            setSaving(false);
        }
    };
    if (!task)
        return <p className="text-gray-500">Loading task...</p>;
    return (<div className="bg-white p-6 rounded-lg shadow space-y-6">
      <div>
        <label className="block text-sm font-semibold text-gray-700">Task ID:</label>
        <p className="text-gray-800">{task.taskId}</p>
      </div>

      <div>
        <label className="block text-sm font-semibold text-gray-700">User ID:</label>
        <p className="text-gray-800">{task.userId}</p>
      </div>

      <div>
        <label className="block text-sm font-semibold text-gray-700">Title:</label>
        {editing ? (<input name="title" value={task.title} onChange={handleChange} className="mt-1 border p-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-blue-400"/>) : (<p className="text-gray-800">{task.title}</p>)}
      </div>

      <div>
        <label className="block text-sm font-semibold text-gray-700">Description:</label>
        {editing ? (<textarea name="description" value={task.description} onChange={handleChange} className="mt-1 border p-2 w-full rounded focus:outline-none focus:ring-2 focus:ring-blue-400"/>) : (<p className="text-gray-800">{task.description}</p>)}
      </div>

      {editing && (<div className="space-y-2">
          <label className="block text-sm font-medium text-gray-700">Upload Image:</label>
          <input type="file" accept="image/*" onChange={handleFileChange} className="block"/>
          {previewUrl && (<img src={previewUrl} alt="Preview" className="w-48 h-auto rounded border"/>)}
        </div>)}

      <div className="pt-4">
        {editing ? (<button onClick={handleSave} disabled={saving} className={`w-full px-4 py-2 text-white font-medium rounded ${saving ? 'bg-blue-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>
            {saving ? 'Saving...' : 'Save'}
          </button>) : (<button onClick={() => setEditing(true)} className="w-full px-4 py-2 bg-gray-300 hover:bg-gray-400 text-black font-medium rounded">
            Edit
          </button>)}
      </div>

      {message && <p className="text-center text-sm mt-2">{message}</p>}

      {labels.length > 0 && (<div className="pt-4">
          <h3 className="text-sm font-semibold text-gray-700">Detected Labels:</h3>
          <ul className="list-disc list-inside text-gray-700 text-sm">
            {labels.map(label => (<li key={label}>{label}</li>))}
          </ul>
        </div>)}
    </div>);
};
exports.default = TaskDetail;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFza0RldGFpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRhc2tEZXRhaWwudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQW1EO0FBQ25ELHNEQUFtRDtBQUNuRCx3REFBcUQ7QUFPckQsTUFBTSxRQUFRLEdBQUcsZ0VBQWdFLENBQUM7QUFFbEYsTUFBTSxVQUFVLEdBQThCLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtJQUNuRSxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBTSxJQUFJLENBQUMsQ0FBQztJQUM1QyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxNQUFNLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUM1QyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBZ0IsSUFBSSxDQUFDLENBQUM7SUFDNUQsTUFBTSxDQUFDLFlBQVksRUFBRSxlQUFlLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBQWMsSUFBSSxDQUFDLENBQUM7SUFDcEUsTUFBTSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBQWdCLElBQUksQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFXLEVBQUUsQ0FBQyxDQUFDO0lBRW5ELElBQUEsaUJBQVMsRUFBQyxHQUFHLEVBQUU7UUFDYixLQUFLLENBQUMsR0FBRyxRQUFRLFFBQVEsQ0FBQzthQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxF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Q0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQ2hDO1VBQUEsRUFBRSxNQUFNLENBQUMsQ0FDVixDQUFDLENBQUMsQ0FBQyxDQUNGLENBQUMsTUFBTSxDQUNMLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUNoQyxTQUFTLENBQUMsK0VBQStFLENBRXpGOztVQUNGLEVBQUUsTUFBTSxDQUFDLENBQ1YsQ0FDSDtNQUFBLEVBQUUsR0FBRyxDQUVMOztNQUFBLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUVqRTs7TUFBQSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ3BCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQ25CO1VBQUEsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLHFDQUFxQyxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FDeEU7VUFBQSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsNkNBQTZDLENBQ3pEO1lBQUEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FDbkIsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FDN0IsQ0FBQyxDQUNKO1VBQUEsRUFBRSxFQUFFLENBQ047UUFBQSxFQUFFLEdBQUcsQ0FBQyxDQUNQLENBQ0g7SUFBQSxFQUFFLEdBQUcsQ0FBQyxDQUNQLENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixrQkFBZSxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IHVwbG9hZEltYWdlIH0gZnJvbSAnLi4vdXRpbHMvdXBsb2FkSW1hZ2UnO1xuaW1wb3J0IHsgcHJvY2Vzc0ltYWdlIH0gZnJvbSAnLi4vdXRpbHMvcHJvY2Vzc0ltYWdlJztcblxuaW50ZXJmYWNlIFRhc2tEZXRhaWxQcm9wcyB7XG4gIHRhc2tJZDogc3RyaW5nO1xuICB1c2VySWQ6IHN0cmluZztcbn1cblxuY29uc3QgQVBJX0JBU0UgPSAnaHR0cHM6Ly91NGU3ZTQ1Z2VlLmV4ZWN1dGUtYXBpLmNhLWNlbnRyYWwtMS5hbWF6b25hd3MuY29tL3Byb2QnO1xuXG5jb25zdCBUYXNrRGV0YWlsOiBSZWFjdC5GQzxUYXNrRGV0YWlsUHJvcHM+ID0gKHsgdGFza0lkLCB1c2VySWQgfSkgPT4ge1xuICBjb25zdCBbdGFzaywgc2V0VGFza10gPSB1c2VTdGF0ZTxhbnk+KG51bGwpO1xuICBjb25zdCBbZWRpdGluZywgc2V0RWRpdGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG4gIGNvbnN0IFtzYXZpbmcsIHNldFNhdmluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XG4gIGNvbnN0IFttZXNzYWdlLCBzZXRNZXNzYWdlXSA9IHVzZVN0YXRlPHN0cmluZyB8IG51bGw+KG51bGwpO1xuICBjb25zdCBbc2VsZWN0ZWRGaWxlLCBzZXRTZWxlY3RlZEZpbGVdID0gdXNlU3RhdGU8RmlsZSB8IG51bGw+KG51bGwpO1xuICBjb25zdCBbcHJldmlld1VybCwgc2V0UHJldmlld1VybF0gPSB1c2VTdGF0ZTxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgY29uc3QgW2xhYmVscywgc2V0TGFiZWxzXSA9IHVzZVN0YXRlPHN0cmluZ1tdPihbXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBmZXRjaChgJHtBUElfQkFTRX0vdGFza3NgKVxuICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgY29uc3QgZm91bmQgPSBkYXRhLmZpbmQoKHQ6IGFueSkgPT4gdC50YXNrSWQgPT09IHRhc2tJZCAmJiB0LnVzZXJJZCA9PT0gdXNlcklkKTtcbiAgICAgICAgc2V0VGFzayhmb3VuZCk7XG4gICAgICB9KTtcbiAgfSwgW3Rhc2tJZCwgdXNlcklkXSk7XG5cbiAgY29uc3QgaGFuZGxlQ2hhbmdlID0gKGU6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50PikgPT4ge1xuICAgIHNldFRhc2soeyAuLi50YXNrLCBbZS50YXJnZXQubmFtZV06IGUudGFyZ2V0LnZhbHVlIH0pO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZUZpbGVDaGFuZ2UgPSAoZTogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICBjb25zdCBmaWxlID0gZS50YXJnZXQuZmlsZXM/LlswXTtcbiAgICBpZiAoZmlsZSkge1xuICAgICAgc2V0U2VsZWN0ZWRGaWxlKGZpbGUpO1xuICAgICAgc2V0UHJldmlld1VybChVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpKTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgaGFuZGxlU2F2ZSA9IGFzeW5jICgpID0+IHtcbiAgICBzZXRTYXZpbmcodHJ1ZSk7XG4gICAgc2V0TWVzc2FnZShudWxsKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRX0vdGFza3NgLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkodGFzayksXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFyZXMub2spIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHVwZGF0ZSB0YXNrJyk7XG4gICAgICBjb25zdCB1cGRhdGVkVGFzayA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICAgIGlmIChzZWxlY3RlZEZpbGUgJiYgdXBkYXRlZFRhc2suaW1hZ2VVcGxvYWRVcmwpIHtcbiAgICAgICAgYXdhaXQgdXBsb2FkSW1hZ2UodXBkYXRlZFRhc2suaW1hZ2VVcGxvYWRVcmwsIHNlbGVjdGVkRmlsZSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvY2Vzc0ltYWdlKHVwZGF0ZWRUYXNrLnRhc2tJZCk7XG4gICAgICAgICAgc2V0TGFiZWxzKHJlc3VsdC5sYWJlbHMubWFwKChsYWJlbDogYW55KSA9PiBsYWJlbC5OYW1lKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgaW1hZ2U6JywgZXJyKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBzZXRUYXNrKHVwZGF0ZWRUYXNrKTtcbiAgICAgIHNldE1lc3NhZ2UoJ+KchSBUYXNrIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IScpO1xuICAgICAgc2V0RWRpdGluZyhmYWxzZSk7XG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIHNldE1lc3NhZ2UoYOKdjCAke2Vyci5tZXNzYWdlfWApO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXRTYXZpbmcoZmFsc2UpO1xuICAgIH1cbiAgfTtcblxuICBpZiAoIXRhc2spIHJldHVybiA8cCBjbGFzc05hbWU9XCJ0ZXh0LWdyYXktNTAwXCI+TG9hZGluZyB0YXNrLi4uPC9wPjtcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwiYmctd2hpdGUgcC02IHJvdW5kZWQtbGcgc2hhZG93IHNwYWNlLXktNlwiPlxuICAgICAgPGRpdj5cbiAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT1cImJsb2NrIHRleHQtc20gZm9udC1zZW1pYm9sZCB0ZXh0LWdyYXktNzAwXCI+VGFzayBJRDo8L2xhYmVsPlxuICAgICAgICA8cCBjbGFzc05hbWU9XCJ0ZXh0LWdyYXktODAwXCI+e3Rhc2sudGFza0lkfTwvcD5cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2PlxuICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPVwiYmxvY2sgdGV4dC1zbSBmb250LXNlbWlib2xkIHRleHQtZ3JheS03MDBcIj5Vc2VyIElEOjwvbGFiZWw+XG4gICAgICAgIDxwIGNsYXNzTmFtZT1cInRleHQtZ3JheS04MDBcIj57dGFzay51c2VySWR9PC9wPlxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxkaXY+XG4gICAgICAgIDxsYWJlbCBjbGFzc05hbWU9XCJibG9jayB0ZXh0LXNtIGZvbnQtc2VtaWJvbGQgdGV4dC1ncmF5LTcwMFwiPlRpdGxlOjwvbGFiZWw+XG4gICAgICAgIHtlZGl0aW5nID8gKFxuICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgbmFtZT1cInRpdGxlXCJcbiAgICAgICAgICAgIHZhbHVlPXt0YXNrLnRpdGxlfVxuICAgICAgICAgICAgb25DaGFuZ2U9e2hhbmRsZUNoYW5nZX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT1cIm10LTEgYm9yZGVyIHAtMiB3LWZ1bGwgcm91bmRlZCBmb2N1czpvdXRsaW5lLW5vbmUgZm9jdXM6cmluZy0yIGZvY3VzOnJpbmctYmx1ZS00MDBcIlxuICAgICAgICAgIC8+XG4gICAgICAgICkgOiAoXG4gICAgICAgICAgPHAgY2xhc3NOYW1lPVwidGV4dC1ncmF5LTgwMFwiPnt0YXNrLnRpdGxlfTwvcD5cbiAgICAgICAgKX1cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2PlxuICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPVwiYmxvY2sgdGV4dC1zbSBmb250LXNlbWlib2xkIHRleHQtZ3JheS03MDBcIj5EZXNjcmlwdGlvbjo8L2xhYmVsPlxuICAgICAgICB7ZWRpdGluZyA/IChcbiAgICAgICAgICA8dGV4dGFyZWFcbiAgICAgICAgICAgIG5hbWU9XCJkZXNjcmlwdGlvblwiXG4gICAgICAgICAgICB2YWx1ZT17dGFzay5kZXNjcmlwdGlvbn1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXtoYW5kbGVDaGFuZ2V9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJtdC0xIGJvcmRlciBwLTIgdy1mdWxsIHJvdW5kZWQgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctMiBmb2N1czpyaW5nLWJsdWUtNDAwXCJcbiAgICAgICAgICAvPlxuICAgICAgICApIDogKFxuICAgICAgICAgIDxwIGNsYXNzTmFtZT1cInRleHQtZ3JheS04MDBcIj57dGFzay5kZXNjcmlwdGlvbn08L3A+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cblxuICAgICAge2VkaXRpbmcgJiYgKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInNwYWNlLXktMlwiPlxuICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9XCJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtZ3JheS03MDBcIj5VcGxvYWQgSW1hZ2U6PC9sYWJlbD5cbiAgICAgICAgICA8aW5wdXRcbiAgICAgICAgICAgIHR5cGU9XCJmaWxlXCJcbiAgICAgICAgICAgIGFjY2VwdD1cImltYWdlLypcIlxuICAgICAgICAgICAgb25DaGFuZ2U9e2hhbmRsZUZpbGVDaGFuZ2V9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJibG9ja1wiXG4gICAgICAgICAgLz5cbiAgICAgICAgICB7cHJldmlld1VybCAmJiAoXG4gICAgICAgICAgICA8aW1nIHNyYz17cHJldmlld1VybH0gYWx0PVwiUHJldmlld1wiIGNsYXNzTmFtZT1cInctNDggaC1hdXRvIHJvdW5kZWQgYm9yZGVyXCIgLz5cbiAgICAgICAgICApfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICl9XG5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwicHQtNFwiPlxuICAgICAgICB7ZWRpdGluZyA/IChcbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVTYXZlfVxuICAgICAgICAgICAgZGlzYWJsZWQ9e3NhdmluZ31cbiAgICAgICAgICAgIGNsYXNzTmFtZT17YHctZnVsbCBweC00IHB5LTIgdGV4dC13aGl0ZSBmb250LW1lZGl1bSByb3VuZGVkICR7XG4gICAgICAgICAgICAgIHNhdmluZyA/ICdiZy1ibHVlLTMwMCBjdXJzb3Itbm90LWFsbG93ZWQnIDogJ2JnLWJsdWUtNjAwIGhvdmVyOmJnLWJsdWUtNzAwJ1xuICAgICAgICAgICAgfWB9XG4gICAgICAgICAgPlxuICAgICAgICAgICAge3NhdmluZyA/ICdTYXZpbmcuLi4nIDogJ1NhdmUnfVxuICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICApIDogKFxuICAgICAgICAgIDxidXR0b25cbiAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHNldEVkaXRpbmcodHJ1ZSl9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJ3LWZ1bGwgcHgtNCBweS0yIGJnLWdyYXktMzAwIGhvdmVyOmJnLWdyYXktNDAwIHRleHQtYmxhY2sgZm9udC1tZWRpdW0gcm91bmRlZFwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgRWRpdFxuICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICApfVxuICAgICAgPC9kaXY+XG5cbiAgICAgIHttZXNzYWdlICYmIDxwIGNsYXNzTmFtZT1cInRleHQtY2VudGVyIHRleHQtc20gbXQtMlwiPnttZXNzYWdlfTwvcD59XG5cbiAgICAgIHtsYWJlbHMubGVuZ3RoID4gMCAmJiAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwicHQtNFwiPlxuICAgICAgICAgIDxoMyBjbGFzc05hbWU9XCJ0ZXh0LXNtIGZvbnQtc2VtaWJvbGQgdGV4dC1ncmF5LTcwMFwiPkRldGVjdGVkIExhYmVsczo8L2gzPlxuICAgICAgICAgIDx1bCBjbGFzc05hbWU9XCJsaXN0LWRpc2MgbGlzdC1pbnNpZGUgdGV4dC1ncmF5LTcwMCB0ZXh0LXNtXCI+XG4gICAgICAgICAgICB7bGFiZWxzLm1hcChsYWJlbCA9PiAoXG4gICAgICAgICAgICAgIDxsaSBrZXk9e2xhYmVsfT57bGFiZWx9PC9saT5cbiAgICAgICAgICAgICkpfVxuICAgICAgICAgIDwvdWw+XG4gICAgICAgIDwvZGl2PlxuICAgICAgKX1cbiAgICA8L2Rpdj5cbiAgKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFRhc2tEZXRhaWw7Il19